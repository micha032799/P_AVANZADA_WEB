USE [proyecto_web]
GO
/****** Object:  Table [dbo].[tCarrito]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tCarrito](
	[IdCarrito] [bigint] IDENTITY(1,1) NOT NULL,
	[IdUsuario] [bigint] NOT NULL,
	[IdProducto] [bigint] NOT NULL,
	[Cantidad] [int] NOT NULL,
	[Fecha] [datetime] NOT NULL,
 CONSTRAINT [PK_TCarrito] PRIMARY KEY CLUSTERED 
(
	[IdCarrito] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tDetalle]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tDetalle](
	[IdDetalle] [bigint] IDENTITY(1,1) NOT NULL,
	[IdFactura] [bigint] NOT NULL,
	[IdProducto] [bigint] NOT NULL,
	[Cantidad] [int] NOT NULL,
	[Impuesto] [decimal](18, 2) NOT NULL,
	[Precio] [decimal](18, 2) NOT NULL,
 CONSTRAINT [PK_TDetalle] PRIMARY KEY CLUSTERED 
(
	[IdDetalle] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tEncabezado]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tEncabezado](
	[IdFactura] [bigint] IDENTITY(1,1) NOT NULL,
	[IdUsuario] [bigint] NOT NULL,
	[FechaPago] [datetime] NOT NULL,
	[TotalPago] [decimal](18, 2) NOT NULL,
 CONSTRAINT [PK_TEncabezado] PRIMARY KEY CLUSTERED 
(
	[IdFactura] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tErrores]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tErrores](
	[IdError] [bigint] NOT NULL,
	[FechaError] [datetime] NULL,
	[Metodo] [varchar](50) NULL,
PRIMARY KEY CLUSTERED 
(
	[IdError] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tProducto]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tProducto](
	[IdProducto] [bigint] IDENTITY(1,1) NOT NULL,
	[Nombre] [varchar](50) NOT NULL,
	[Descripcion] [varchar](250) NOT NULL,
	[Precio] [decimal](18, 2) NOT NULL,
	[Imagen] [varchar](500) NOT NULL,
	[Cantidad] [int] NULL,
 CONSTRAINT [PK_TProducto] PRIMARY KEY CLUSTERED 
(
	[IdProducto] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tRol]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tRol](
	[IdRol] [smallint] IDENTITY(1,1) NOT NULL,
	[Nombre] [varchar](50) NOT NULL,
 CONSTRAINT [PK_tRol] PRIMARY KEY CLUSTERED 
(
	[IdRol] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
/****** Object:  Table [dbo].[tUsuario]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tUsuario](
	[IdUsuario] [bigint] IDENTITY(1,1) NOT NULL,
	[Correo] [varchar](200) NOT NULL,
	[Contrasenna] [varchar](200) NOT NULL,
	[Nombre] [varchar](200) NOT NULL,
	[IdRol] [smallint] NOT NULL,
	[Estado] [bit] NOT NULL,
	[EsTemporal] [bit] NULL,
 CONSTRAINT [PK_tUsuario] PRIMARY KEY CLUSTERED 
(
	[IdUsuario] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY],
 CONSTRAINT [UK_Correo] UNIQUE NONCLUSTERED 
(
	[Correo] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO
ALTER TABLE [dbo].[tUsuario]  WITH CHECK ADD  CONSTRAINT [FK_tUsuario_tRol] FOREIGN KEY([IdRol])
REFERENCES [dbo].[tRol] ([IdRol])
GO
ALTER TABLE [dbo].[tUsuario] CHECK CONSTRAINT [FK_tUsuario_tRol]
GO
/****** Object:  StoredProcedure [dbo].[ActualizarPerfil]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[ActualizarPerfil]
	@IdUsuario		BIGINT,
	@NombreUsuario	VARCHAR(200),
	@Correo			VARCHAR(200),
	@Contrasenna	VARCHAR(200),
	@bActualizarClave BIT
AS
BEGIN

	UPDATE dbo.tUsuario
	   SET Correo = @Correo,
		   Contrasenna = (CASE WHEN @bActualizarClave = 1 THEN @Contrasenna ELSE Contrasenna END),
		   Nombre = @NombreUsuario
	 WHERE IdUsuario = @IdUsuario

END
GO
/****** Object:  StoredProcedure [dbo].[CambiarContrasenna]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[CambiarContrasenna]
	@Correo					VARCHAR(200),
	@Contrasenna			VARCHAR(200),
	@ContrasennaTemporal	VARCHAR(200),
	@EsTemporal				BIT
AS
BEGIN

	DECLARE @Consecutivo BIGINT

	SELECT @Consecutivo = IdUsuario
	FROM	tUsuario
	WHERE	Correo = @Correo
		AND Contrasenna = @ContrasennaTemporal
		AND Estado = 1

	IF(@Consecutivo IS NOT NULL)
	BEGIN
		UPDATE	tUsuario
		SET		Contrasenna = @Contrasenna,
				EsTemporal  = @EsTemporal
		WHERE	Correo = @Correo
	END

	SELECT	IdUsuario,Correo,U.Nombre 'NombreUsuario',U.IdRol,R.Nombre 'NombreRol',Estado
	FROM	tUsuario U
	INNER	JOIN tRol R ON U.IdRol = R.IdRol	
	WHERE	Correo = @Correo

END
GO
/****** Object:  StoredProcedure [dbo].[ConsultarCarrito]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[ConsultarCarrito]
    @IdUsuario BIGINT
AS
BEGIN
    SELECT IdCarrito,
           IdUsuario,
           C.IdProducto,
           C.Cantidad,
           Fecha,
           P.Precio,
           P.Precio * C.Cantidad 'SubTotal',
           (P.Precio * C.Cantidad) * 0.13 'Impuesto',
           P.Precio * C.Cantidad + (P.Precio * C.Cantidad) * 0.13 'Total',
           P.Nombre
    FROM dbo.TCarrito C
    INNER JOIN dbo.TProducto P ON C.IdProducto = P.IdProducto
    WHERE IdUsuario = @IdUsuario
END
GO
/****** Object:  StoredProcedure [dbo].[ConsultarDetalleFactura]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ConsultarDetalleFactura]
    @IdFactura BIGINT
AS
BEGIN
    SELECT D.IdFactura,
           D.Cantidad,
           D.Precio,
           D.Impuesto,
           D.Precio * D.Cantidad 'SubTotal',
           (D.Impuesto * D.Cantidad) 'ImpuestoTotal',
           (D.Precio * D.Cantidad) + (D.Impuesto * D.Cantidad) 'Total',
           P.Nombre
    FROM dbo.TDetalle D
    INNER JOIN dbo.TProducto P ON D.IdProducto = P.IdProducto
    WHERE IdFactura = @IdFactura
END
GO
/****** Object:  StoredProcedure [dbo].[ConsultarFacturas]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[ConsultarFacturas]
    @IdUsuario BIGINT
AS
BEGIN
    SELECT IdFactura,
           FechaPago,
           TotalPago
    FROM dbo.TEncabezado
    WHERE IdUsuario = @IdUsuario
END

GO
/****** Object:  StoredProcedure [dbo].[ConsultarProductos]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
Create PROCEDURE [dbo].[ConsultarProductos]
AS
BEGIN
    
    SELECT * FROM dbo.TProducto;
END;
GO
/****** Object:  StoredProcedure [dbo].[ConsultarUsuario]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[ConsultarUsuario]
	@IdUsuario BIGINT
AS
BEGIN
	
	SELECT	IdUsuario,Correo,U.Nombre 'NombreUsuario',U.IdRol,R.Nombre 'NombreRol',Estado,EsTemporal
	FROM	tUsuario U
	INNER	JOIN tRol R ON U.IdRol = R.IdRol
	WHERE	IdUsuario = @IdUsuario

END
GO
/****** Object:  StoredProcedure [dbo].[EditarProducto]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[EditarProducto]
    @idProducto bigint,
    @nombre varchar(200),
    @descripcion varchar(500),
    @precio decimal(10, 2),
    @imagen varchar(500),
    @cantidad int 
AS
BEGIN
    UPDATE dbo.tProducto
    SET nombre = @nombre,
        descripcion = @descripcion,
        precio = @precio,
        Imagen = @imagen,
        Cantidad = @cantidad  
    WHERE IdProducto = @idProducto;
END;
GO
/****** Object:  StoredProcedure [dbo].[EliminarProductoPorId]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[EliminarProductoPorId]
    @idProducto bigint
AS
BEGIN
    
    DELETE FROM dbo.tProducto
    WHERE IdProducto = @idProducto;
END;
GO
/****** Object:  StoredProcedure [dbo].[IniciarSesion]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[IniciarSesion]
	@Correo			varchar(200),
	@Contrasenna	varchar(200)
AS
BEGIN
	
	SELECT	IdUsuario,Correo,U.Nombre 'NombreUsuario',U.IdRol,R.Nombre 'NombreRol',Estado,EsTemporal
	FROM	tUsuario U
	INNER	JOIN tRol R ON U.IdRol = R.IdRol
	WHERE	Correo = @Correo
		AND Contrasenna = @Contrasenna
		AND Estado = 1

END
GO
/****** Object:  StoredProcedure [dbo].[RecuperarAcceso]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[RecuperarAcceso]
	@Correo			VARCHAR(200),
	@Contrasenna	VARCHAR(200),
	@EsTemporal		BIT
AS
BEGIN

	DECLARE @Consecutivo BIGINT

	SELECT @Consecutivo = IdUsuario
	FROM	tUsuario
	WHERE	Correo = @Correo
		AND Estado = 1

	IF(@Consecutivo IS NOT NULL)
	BEGIN
		UPDATE	tUsuario
		SET		Contrasenna = @Contrasenna,
				EsTemporal  = @EsTemporal
		WHERE	Correo = @Correo
	END

	SELECT	IdUsuario,Correo,U.Nombre 'NombreUsuario',U.IdRol,R.Nombre 'NombreRol',Estado
	FROM	tUsuario U
	INNER	JOIN tRol R ON U.IdRol = R.IdRol	
	WHERE	Correo = @Correo

END
GO
/****** Object:  StoredProcedure [dbo].[RegistrarProducto]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[RegistrarProducto]
    @nombre varchar(200),
    @descripcion varchar(500),
    @precio decimal(10, 2),
    @imagen varchar(500),
	@cantidad int 
AS
BEGIN
    INSERT INTO dbo.tProducto (Nombre, Descripcion, Precio, Imagen, cantidad)
    VALUES (@nombre, @descripcion, @precio, @imagen, @cantidad );
END;
GO
/****** Object:  StoredProcedure [dbo].[RegistrarUsuario]    Script Date: 31/3/2024 22:28:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[RegistrarUsuario]
	@Correo			varchar(200),
	@Contrasenna	varchar(200),
	@NombreUsuario	varchar(200)
AS
BEGIN

	IF NOT EXISTS(SELECT 1 FROM tUsuario WHERE Correo = @Correo)
	BEGIN

		INSERT INTO dbo.tUsuario(Correo,Contrasenna,Nombre,IdRol,Estado,EsTemporal)
	    VALUES(@Correo,@Contrasenna,@NombreUsuario,1,1,0)

	END

END
GO
